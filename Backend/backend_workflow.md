# Backend Workflow: Quizcraze (Node.js)

## Phase 1: Project Setup & User Authentication

-   [x] **Initialize Node.js Project**
    -   [x] Create `package.json` (`npm init -y`)
    -   [x] Install core dependencies (Express.js, Mongoose/Sequelize, bcryptjs, jsonwebtoken, dotenv, cors)
-   [x] **Setup Folder Structure**
    -   [x] `/config` (for database connection, environment variables)
    -   [x] `/models` (for Mongoose/Sequelize schemas/models)
    -   [x] `/controllers` (for request handling logic)
    -   [x] `/routes` (for API endpoint definitions)
    -   [x] `/middleware` (for authentication, error handling, etc.)
    -   [x] `/utils` (for helper functions)
-   [x] **Environment Configuration**
    -   [x] Create environment example in README.md (instead of .env)
    -   [x] Create `config.js` to load environment variables.
-   [x] **Database Setup**
    -   [x] Choose a database (MongoDB with Mongoose)
    -   [x] Implement database connection logic in `config/db.js`.
-   [x] **User Models (Teacher & Student)**
    -   [x] Define `Teacher` schema/model (`name`, `email`, `password`, `createdClasses`) in `models/Teacher.js`.
    -   [x] Define `Student` schema/model (`name`, `email`, `password`, `enrolledClasses`, `quizAttempts`) in `models/Student.js`.
    -   [x] Implement password hashing for both models.
-   [x] **Authentication Controllers**
    -   [x] `registerTeacher` controller in `controllers/authController.js`:
        -   [x] Validate input (name, email, password).
        -   [x] Check if email already exists.
        -   [x] Hash password.
        -   [x] Create and save new Teacher.
        -   [x] Generate JWT token.
    -   [x] `loginTeacher` controller in `controllers/authController.js`:
        -   [x] Validate input (email, password).
        -   [x] Find Teacher by email.
        -   [x] Compare hashed password.
        -   [x] Generate JWT token.
    -   [x] `registerStudent` controller in `controllers/authController.js`:
        -   [x] Validate input (name, email, password).
        -   [x] Check if email already exists.
        -   [x] Hash password.
        -   [x] Create and save new Student.
        -   [x] Generate JWT token.
    -   [x] `loginStudent` controller in `controllers/authController.js`:
        -   [x] Validate input (email, password).
        -   [x] Find Student by email.
        -   [x] Compare hashed password.
        -   [x] Generate JWT token.
-   [x] **Authentication Routes**
    -   [x] Define routes in `routes/authRoutes.js`:
        -   [x] `POST /api/auth/teacher/register`
        -   [x] `POST /api/auth/teacher/login`
        -   [x] `POST /api/auth/student/register`
        -   [x] `POST /api/auth/student/login`
-   [x] **Authentication Middleware**
    -   [x] Create `authMiddleware.js` in `/middleware` to protect routes:
        -   [x] Verify JWT token.
        -   [x] Attach user information to request object (`req.user`).
        -   [x] Differentiate between Teacher and Student roles if necessary for certain routes.
-   [x] **Main App File (`server.js` or `app.js`)**
    -   [x] Import dependencies.
    -   [x] Connect to database.
    -   [x] Use middleware (CORS, body parser for JSON).
    -   [x] Mount auth routes.
    -   [x] Basic error handling middleware.
    -   [x] Start the server.
-   [x] **Testing Phase 1**
    -   [x] Test Teacher registration and login using Postman or similar tool.
    -   [x] Test Student registration and login.
    -   [x] Verify token generation and protected route access.

## Phase 2: Class Management

-   [x] **Class Model**
    -   [x] Define `Class` schema/model in `models/Class.js`:
        -   [x] `className` (String, required)
        -   [x] `enrollmentKey` (String, unique, required)
        -   [x] `teacher` (ObjectId, ref: 'Teacher', required)
        -   [x] `students` (Array of ObjectId, ref: 'Student')
        -   [x] `quizzes` (Array of ObjectId, ref: 'Quiz')
-   [x] **Class Controllers (`controllers/classController.js`)**
    -   [x] `createClass` (Teacher only):
        -   [x] Input: `className`.
        -   [x] Generate a unique `enrollmentKey`.
        -   [x] Associate with the logged-in Teacher (`req.user.id`).
        -   [x] Save new Class.
        -   [x] Update Teacher's `createdClasses` array.
    -   [x] `joinClass` (Student only):
        -   [x] Input: `enrollmentKey`.
        -   [x] Find Class by `enrollmentKey`.
        -   [x] If Class exists and Student is not already enrolled:
            -   [x] Add Student's ID to Class's `students` array.
            -   [x] Add Class's ID to Student's `enrolledClasses` array.
        -   [x] Handle cases: class not found, already enrolled.
    -   [x] `getTeacherClasses` (Teacher only):
        -   [x] Fetch all classes created by the logged-in Teacher.
    -   [x] `getStudentClasses` (Student only):
        -   [x] Fetch all classes the logged-in Student is enrolled in.
    -   [x] `getClassDetails` (Teacher/Student, based on role and enrollment/ownership):
        -   [x] Fetch specific class details, potentially populating students or quizzes.
-   [x] **Class Routes (`routes/classRoutes.js`)**
    -   [x] `POST /api/classes` (Teacher, `authMiddleware`, `createClass`)
    -   [x] `POST /api/classes/join` (Student, `authMiddleware`, `joinClass`)
    -   [x] `GET /api/classes/teacher` (Teacher, `authMiddleware`, `getTeacherClasses`)
    -   [x] `GET /api/classes/student` (Student, `authMiddleware`, `getStudentClasses`)
    -   [x] `GET /api/classes/:classId` (Teacher/Student, `authMiddleware`, `getClassDetails`)
-   [x] **Update User Models**
    -   [x] Ensure `createdClasses` in `Teacher` model is updated correctly.
    -   [x] Ensure `enrolledClasses` in `Student` model is updated correctly.
-   [x] **Testing Phase 2**
    -   [x] Test Teacher creating a class.
    -   [x] Test Student joining a class with enrollment key.
    -   [x] Test fetching classes for both Teacher and Student dashboards.
    -   [x] Test edge cases (invalid key, already joined).

## Phase 3: Quiz Management

-   [x] **Quiz Model (`models/Quiz.js`)**
    -   [x] Define `Quiz` schema/model:
        -   `title` (String, required)
        -   `description` (String, optional)
        -   `questions` (Array of Question sub-documents)
            -   `questionText` (String, required)
            -   `options` (Array of Option sub-documents)
                -   `optionText` (String, required)
                -   `isCorrect` (Boolean, default: false)
            -   `multipleCorrectAnswers` (Boolean, default: false) // To determine if multiple options can be correct
        -   `createdBy` (ObjectId, ref: 'Teacher', required)
        -   `assignedClasses` (Array of ObjectId, ref: 'Class')
-   [x] **Quiz Controllers (`controllers/quizController.js`)**
    -   [x] `createQuiz` (Teacher only):
        -   Input: `title`, `description` (optional), `questions` (array of question objects with options and correct answers).
        -   Validate input structure.
        -   Associate with the logged-in Teacher (`req.user.id`).
        -   Save new Quiz.
    -   [x] `assignQuizToClass` (Teacher only):
        -   Input: `quizId`, `classId`.
        -   Verify Teacher owns the quiz and the class.
        -   Add `classId` to Quiz's `assignedClasses` array.
        -   Add `quizId` to Class's `quizzes` array.
    -   [x] `getQuizzesByTeacher` (Teacher only):
        -   Fetch all quizzes created by the logged-in Teacher.
    -   [x] `getQuizzesForClass` (Teacher/Student):
        -   Input: `classId`.
        -   Verify Student is enrolled or Teacher owns the class.
        -   Fetch quizzes assigned to that class (populate details).
    -   [x] `getQuizDetails` (Teacher/Student):
        -   Input: `quizId`.
        -   Fetch specific quiz details. For students, do not reveal `isCorrect` flag before attempt.
-   [x] **Quiz Routes (`routes/quizRoutes.js`)**
    -   [x] `POST /api/quizzes` (Teacher, `authMiddleware`, `createQuiz`)
    -   [x] `POST /api/quizzes/:quizId/assign/:classId` (Teacher, `authMiddleware`, `assignQuizToClass`)
    -   [x] `GET /api/quizzes/teacher` (Teacher, `authMiddleware`, `getQuizzesByTeacher`)
    -   [x] `GET /api/quizzes/class/:classId` (Teacher/Student, `authMiddleware`, `getQuizzesForClass`)
    -   [x] `GET /api/quizzes/:quizId` (Teacher/Student, `authMiddleware`, `getQuizDetails`)
-   [x] **Update Class Model**
    -   [x] Ensure `quizzes` array in `Class` model is updated correctly.
-   [x] **Testing Phase 3**
    -   [x] Test Teacher creating a quiz with MCQs.
    -   [x] Test Teacher assigning a quiz to one or more classes.
    -   [x] Test fetching quizzes for a Teacher.
    -   [x] Test fetching quizzes available to a Student in an enrolled class (ensure correct answers are hidden).

## Phase 4: Quiz Attempt & Results

-   [x] **QuizAttempt Model (`models/QuizAttempt.js`)**
    -   [x] Define `QuizAttempt` schema/model:
        -   `quiz` (ObjectId, ref: 'Quiz', required)
        -   `student` (ObjectId, ref: 'Student', required)
        -   `answers` (Array of selected answers, structure to match quiz questions format, e.g., `[{ questionId: ObjectId, selectedOptionIds: [ObjectId] }]` or `[{ questionIndex: Number, selectedOptionIndices: [Number] }]`)
        -   `score` (Number, calculated)
        -   `totalMarks` (Number, from quiz)
        -   `submittedAt` (Date, default: Date.now)
        -   `classContext` (ObjectId, ref: 'Class', optional, if attempted within a specific class context)
-   [x] **Quiz Attempt Controllers (`controllers/attemptController.js`)**
    -   [x] `submitQuiz` (Student only):
        -   Input: `quizId`, `answers` (student's selected options for each question), `classId` (optional).
        -   Verify Student has not attempted this quiz before (for now).
        -   Fetch the Quiz with correct answers.
        -   Calculate score by comparing student's answers with correct answers.
        -   Create and save `QuizAttempt` document.
        -   Store reference to this attempt in `Student.quizAttempts`.
        -   Return the result (score, correct answers for review).
    -   [x] `getStudentResults` (Student only):
        -   Fetch all `QuizAttempt` records for the logged-in Student, possibly populated with quiz titles.
    -   [x] `getQuizResultsForTeacher` (Teacher only):
        -   Input: `quizId`, `classId`.
        -   Verify Teacher owns the quiz and class.
        -   Fetch all `QuizAttempt` records for that specific quiz within that specific class.
        -   Populate student names and scores.
-   [x] **Quiz Attempt Routes (`routes/attemptRoutes.js`)**
    -   [x] `POST /api/attempts/submit` (Student, `authMiddleware`, `submitQuiz`)
    -   [x] `GET /api/attempts/student` (Student, `authMiddleware`, `getStudentResults`)
    -   [x] `GET /api/attempts/teacher/:quizId/class/:classId` (Teacher, `authMiddleware`, `getQuizResultsForTeacher`)
-   [x] **Update Student Model**
    -   [x] Add `quizAttempts` (Array of ObjectId, ref: 'QuizAttempt') to `Student` model.
-   [x] **Testing Phase 4**
    -   [x] Test Student attempting a quiz.
    -   [x] Verify score calculation is correct.
    -   [x] Verify one-attempt-per-quiz rule (for now).
    -   [x] Test Student viewing their past results.
    -   [x] Test Teacher viewing results for a specific quiz in a specific class.

## Phase 5: Question Bank & Self-Practice Setup

-   [x] **QuestionBank Model (`models/QuestionBank.js`)**
    -   [x] Define `QuestionBank` schema/model:
        -   `title` (String, required)
        -   `description` (String, optional)
        -   `questions` (Array of Question sub-documents - similar to Quiz model's questions)
            -   `questionText` (String, required)
            -   `options` (Array of Option sub-documents)
                -   `optionText` (String, required)
                -   `isCorrect` (Boolean, default: false)
            -   `multipleCorrectAnswers` (Boolean, default: false)
            -   `difficultyLevel` (Number, required, min: 1, max: 5) 
        -   `createdBy` (ObjectId, ref: 'Teacher', required)
        -   `assignedClasses` (Array of ObjectId, ref: 'Class')
    -   [x] Ensure at least one question is required for a question bank.
-   [x] **SelfPracticeProgress Model (`models/SelfPracticeProgress.js`)**
    -   [x] Define `SelfPracticeProgress` schema/model:
        -   `student` (ObjectId, ref: 'Student', required)
        -   `questionBank` (ObjectId, ref: 'QuestionBank', required)
        -   `currentAdaptiveDifficulty` (Number, default: 1)
        -   `questionsAttemptedInSession` (Array of ObjectId, ref: 'Question' from QuestionBank) // To track questions seen in current extended session to manage repetition for a batch
        -   `lastAttemptedAt` (Date, default: Date.now)
    -   [x] Add compound index for `student` and `questionBank` for efficient lookups.
-   [x] **Teacher-Side Question Bank Controllers (`controllers/questionBankController.js`)**
    -   [x] `createQuestionBank` (Teacher only):
        -   Input: `title`, `description` (optional), `questions` (array with `difficultyLevel`).
        -   Validate input (title, at least one question, valid difficulty levels).
        -   Associate with the logged-in Teacher (`req.user.id`).
        -   Save new `QuestionBank`.
    -   [x] `getTeacherQuestionBanks` (Teacher only):
        -   Fetch all question banks created by the logged-in Teacher.
    -   [x] `getQuestionBankById` (Teacher only):
        -   Input: `questionBankId`.
        -   Fetch specific question bank details (owned by the teacher).
    -   [x] `updateQuestionBank` (Teacher only):
        -   Input: `questionBankId`, fields to update (title, description, questions).
        -   Verify Teacher owns the question bank.
        -   Update and save.
    -   [x] `deleteQuestionBank` (Teacher only):
        -   Input: `questionBankId`.
        -   Verify Teacher owns the question bank.
        -   Delete the question bank. (Consider if associated `SelfPracticeProgress` should also be cleaned up or archived).
    -   [x] `assignQuestionBankToClass` (Teacher only):
        -   Input: `questionBankId`, `classId`.
        -   Verify Teacher owns the question bank and the class.
        -   Add `classId` to `QuestionBank`'s `assignedClasses` array.
        -   (Optional: Add `questionBankId` to `Class`'s `availableQuestionBanks` array if modifying Class model).
-   [x] **Teacher-Side Question Bank Routes (`routes/questionBankRoutes.js`)**
    -   [x] `POST /api/question-banks` (Teacher, `authMiddleware`, `createQuestionBank`)
    -   [x] `GET /api/question-banks/teacher` (Teacher, `authMiddleware`, `getTeacherQuestionBanks`)
    -   [x] `GET /api/question-banks/:questionBankId` (Teacher, `authMiddleware`, `getQuestionBankById`)
    -   [x] `PUT /api/question-banks/:questionBankId` (Teacher, `authMiddleware`, `updateQuestionBank`)
    -   [x] `DELETE /api/question-banks/:questionBankId` (Teacher, `authMiddleware`, `deleteQuestionBank`)
    -   [x] `POST /api/question-banks/:questionBankId/assign/:classId` (Teacher, `authMiddleware`, `assignQuestionBankToClass`)
-   [x] **Update Main App File (`server.js`)**
    -   [x] Mount `questionBankRoutes`.
-   [x] **Initial Testing Phase 5**
    -   [x] Test Teacher creating a question bank with various difficulty questions.
    -   [x] Test Teacher retrieving, updating, and deleting their question banks.
    -   [x] Test Teacher assigning a question bank to a class.

## Phase 6: Student Self-Practice Adaptive Quiz Logic

-   [x] **Student-Side Self-Practice Controllers (`controllers/selfPracticeController.js`)**
    -   [x] `getAvailableQuestionBanks` (Student only):
        -   Fetch all `QuestionBank`s assigned to classes the student is enrolled in.
        -   Populate basic `QuestionBank` info (title, description).
    -   [x] `startOrResumePracticeSession` (Student only):
        -   Input: `questionBankId`.
        -   Find or create `SelfPracticeProgress` for the student and question bank.
        -   If resuming, potentially clear `questionsAttemptedInSession` if `lastAttemptedAt` is too old (e.g., >24 hours) to reset session repetition tracking.
        -   Call a helper function/service to get the first batch of 5 questions.
    -   [x] `getPracticeQuizBatch` (Helper function or part of `startOrResumePracticeSession` logic):
        -   Input: `studentId`, `questionBankId`, `currentAdaptiveDifficulty`, `questionsAttemptedInSession` (from `SelfPracticeProgress`).
        -   Logic:
            -   Fetch up to 5 questions from `QuestionBank` matching `currentAdaptiveDifficulty`.
            -   Filter out questions present in `questionsAttemptedInSession` for the current batch if possible.
            -   If fewer than 5 questions at `currentAdaptiveDifficulty` (after filtering or in total):
                -   Attempt to fill the remaining slots from `currentAdaptiveDifficulty + 1` then `currentAdaptiveDifficulty - 1` (or vice versa), prioritizing unseen questions.
                -   If still fewer than 5, serve a smaller batch.
            -   If `QuestionBank` has very few questions overall (e.g., < 5 total), return an appropriate message/status.
            -   Return the batch of questions (without correct answers exposed to student yet).
    -   [x] `submitPracticeBatchAnswers` (Student only):
        -   Input: `questionBankId`, `practiceSessionId` (or use student+QB to identify progress), `answers` (array of selected options for the batch).
        -   Fetch the `QuestionBank` questions (with correct answers) corresponding to the batch.
        -   Calculate score for the batch (e.g., number of correct answers out of 5).
        -   Update `SelfPracticeProgress`:
            -   Add attempted question IDs to `questionsAttemptedInSession`.
            -   Adjust `currentAdaptiveDifficulty` based on score:
                -   >=80% correct (4-5/5): difficulty + 1 (max 5).
                -   <=20% correct (0-1/5): difficulty - 1 (min 1).
                -   Else: difficulty same.
            -   Update `lastAttemptedAt`.
        -   Return score, total marks for the batch, and potentially the next batch of questions (by calling `getPracticeQuizBatch` again).
-   [x] **Student-Side Self-Practice Routes (`routes/selfPracticeRoutes.js`)**
    -   [x] `GET /api/self-practice/banks` (Student, `authMiddleware`, `getAvailableQuestionBanks`)
    -   [x] `POST /api/self-practice/start/:questionBankId` (Student, `authMiddleware`, `startOrResumePracticeSession`) // Could also be a GET if it just returns the first batch
    -   [x] `POST /api/self-practice/submit/:questionBankId` (Student, `authMiddleware`, `submitPracticeBatchAnswers`)
-   [x] **Update Main App File (`server.js`)**
    -   [x] Mount `selfPracticeRoutes`.
-   [x] **Error Handling & Edge Cases for Adaptive Logic**
    -   [x] Handle `QuestionBank` with < 5 questions overall.
    -   [x] Handle scenarios where a difficulty level has no questions or all have been recently attempted.
    -   [x] Ensure `currentAdaptiveDifficulty` stays within 1-5 bounds.
-   [x] **Testing Phase 6**
    -   [x] Test student fetching available question banks.
    -   [x] Test student starting a practice session and receiving the first batch (difficulty 1).
    -   [x] Test submitting answers for a batch and verify score calculation.
    -   [x] Test adaptive difficulty adjustment: increasing, decreasing, and staying the same based on performance.
    -   [x] Test question selection logic: preference for unseen questions, handling of small question pools at certain difficulties.
    -   [x] Test continuous attempts and question repetition when the pool of unique questions is exhausted for a session.
    -   [x] Test error handling for invalid inputs or non-existent resources.

## Phase 7: Quiz Leaderboards

-   [x] **Leaderboard Logic Design (Backend Focus)**
    -   [x] Confirm data source: `QuizAttempt` model.
    -   [x] Define primary sorting key: `score` (descending).
    -   [x] Define secondary tie-breaking key: `submittedAt` (ascending - earlier submission ranks higher).
    -   [x] Define pagination strategy for API responses (e.g., using `page` and `limit` query parameters).
-   [x] **Leaderboard Controller (`controllers/leaderboardController.js`)**
    -   [x] Create `leaderboardController.js`.
    -   [x] Implement `getQuizLeaderboardByClass(req, res)`:
        -   [x] Inputs: `quizId`, `classId` (from `req.params`), `req.user` (for auth).
        -   [x] Validate existence of `quizId` and `classId`.
        -   [x] Permissions:
            -   **Student**: Verify student is enrolled in the `classId` and the `quizId` is assigned to that class.
            -   **Teacher**: Verify teacher owns the `quizId` AND owns/manages the `classId`.
        -   [x] Data Fetching:
            -   Query `QuizAttempt` collection.
            -   Filter by `quiz: quizId` AND `classContext: classId`.
            -   Populate `student` details (e.g., `name`).
        -   [x] Sorting: Apply primary (`score` desc) and secondary (`submittedAt` asc) sorting.
        -   [x] Implement pagination based on query parameters.
        -   [x] Data Formatting: Transform the sorted list into a ranked list, e.g., `[{ rank: 1, studentName: "Student Name", studentId: "...", score: 95, submittedAt: "..." }, ...]`.
        -   [x] Handle cases where no attempts exist for the quiz in the class.
-   [x] **Leaderboard Routes (`routes/leaderboardRoutes.js`)**
    -   [x] Create `leaderboardRoutes.js`.
    -   [x] Define `GET /api/leaderboards/quiz/:quizId/class/:classId` route.
        -   [x] Protect with `authMiddleware`.
        -   [x] Map to `leaderboardController.getQuizLeaderboardByClass`.
-   [x] **Database Optimizations**
    -   [x] Review and add a compound index to `QuizAttempt` model to optimize leaderboard queries. Implemented: `{ quiz: 1, classContext: 1, score: -1, submittedAt: 1 }`.
-   [x] **Update Main App File (`server.js` or `app.js`)**
    -   [x] Import and mount `leaderboardRoutes` under an appropriate base path (e.g., `/api/leaderboards`).
-   [x] **Backend Testing (Phase 7)**
    -   [x] Test `GET /api/leaderboards/quiz/:quizId/class/:classId` endpoint:
        -   [x] As a Teacher: Verify access to leaderboards for their quizzes within their classes.
        -   [x] As a Student: Verify access to leaderboards for quizzes in their enrolled classes.
        -   [x] Verify correct data structure, ranking, and tie-breaking logic.
        -   [x] Test pagination (requesting different pages and limits).
        -   [x] Test access denial for unauthorized users or non-existent resources.
        -   [x] Test response when a quiz has no attempts in a specific class.

 